;; ============================================
;; pgBouncer Configuration
;; Паттерн: Connection Pooling для High Load
;; Цель: 1000+ concurrent users, 90% reduction DB connections
;; ============================================

[databases]
; Формат: dbname = host=hostname port=port dbname=database
city_delivery = host=postgres port=5432 dbname=city_delivery user=admin password=password

; Fallback database для maintenance
* = host=postgres port=5432

[pgbouncer]
;;;
;;; Administrative settings
;;;

; Логи
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

;;;
;;; Connection settings
;;;

; IP address or * to listen on all addresses
listen_addr = *
listen_port = 6432

; Unix socket (опционально)
unix_socket_dir = /tmp

;;;
;;; Authentication settings
;;;

; Метод аутентификации (md5, scram-sha-256, trust, plain, peer)
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;;;
;;; Pooling mode settings
;;;

; Режим пулинга:
; - session: одно соединение на сессию (безопасно, но медленно)
; - transaction: одно соединение на транзакцию (РЕКОМЕНДУЕТСЯ)
; - statement: одно соединение на запрос (только для read-only)
pool_mode = transaction

;;;
;;; Connection limits
;;;

; Максимум клиентских подключений
max_client_conn = 1000

; Максимум подключений к одной БД (PostgreSQL default: 100)
default_pool_size = 20

; Минимум подключений в пуле (keep-alive)
min_pool_size = 5

; Резерв для admin/superuser подключений
reserve_pool_size = 5

; Таймаут ожидания подключения (секунды)
reserve_pool_timeout = 5

;;;
;;; Timeouts
;;;

; Таймаут для idle серверных подключений (секунды)
server_idle_timeout = 600

; Таймаут для idle клиентских подключений (секунды)
server_lifetime = 3600

; Таймаут запроса (секунды, 0 = disabled)
query_timeout = 0

; Таймаут ожидания в очереди (секунды)
query_wait_timeout = 120

; Таймаут подключения к серверу
server_connect_timeout = 15

;;;
;;; Performance
;;;

; Отключить Nagle's algorithm для меньшей latency
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 10
tcp_keepcnt = 5

; DNS кэширование
dns_max_ttl = 15
dns_nxdomain_ttl = 15

;;;
;;; Logging
;;;

; Уровень логирования (DEBUG, INFO, WARNING, ERROR)
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

; Verbose логи (для отладки)
verbose = 0

;;;
;;; Security
;;;

; Игнорировать startup параметры
ignore_startup_parameters = extra_float_digits

;;;
;;; Database defaults
;;;

; Кодировка по умолчанию
client_encoding = utf8

;;;
;;; Statistics
;;;

; Включить статистику
stats_users = admin
stats_period = 60

;;;
;;; Administrative
;;;

; Admin users
admin_users = admin


