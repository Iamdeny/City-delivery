/**
 * Ð“Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» ÑÐµÑ€Ð²ÐµÑ€Ð°
 * ÐœÐ°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€ÑƒÐµÐ¼Ð°Ñ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ð´Ð»Ñ MVP Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð²
 */

const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const cors = require('cors');
const helmet = require('helmet');
const compression = require('compression');
const rateLimit = require('express-rate-limit');
require('dotenv').config();

// Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
const authRoutes = require('./src/routes/auth');
const orderRoutes = require('./src/routes/orders');
const productRoutes = require('./src/routes/products');
const cartRoutes = require('./src/routes/cart');         // âœ… Phase 3: Smart Cart
const trackingRoutes = require('./src/routes/tracking'); // âœ… Phase 3: Real-time Tracking
const checkoutRoutes = require('./src/routes/checkout'); // âœ… Phase 4: Checkout Optimization
const paymentRoutes = require('./src/routes/payments');   // âœ… Payments: Ð®Kassa Integration
// TODO: Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
// const courierRoutes = require('./src/routes/couriers');
// const pickerRoutes = require('./src/routes/pickers');
// const adminRoutes = require('./src/routes/admin');

// Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ WebSocket Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¾Ð²
const setupWebSocket = require('./src/websocket/socketHandler');

// Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
const queueService = require('./src/services/queueService');

const app = express();
const server = http.createServer(app);

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Socket.io
const io = socketIo(server, {
  cors: {
    origin: process.env.FRONTEND_URL || 'http://localhost:3000',
    methods: ['GET', 'POST'],
    credentials: true,
  },
});

// ============ MIDDLEWARE ============

// Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
app.use(helmet());

// Ð¡Ð¶Ð°Ñ‚Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²
app.use(compression());

// CORS
app.use(
  cors({
    origin: process.env.FRONTEND_URL || 'http://localhost:3000',
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization'],
    credentials: true,
  })
);

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 Ð¼Ð¸Ð½ÑƒÑ‚
  max: 100, // Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 100 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ Ð¾Ð´Ð½Ð¾Ð³Ð¾ IP
  message: 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ',
});
app.use('/api/', limiter);

// ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ JSON
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// ============ ROUTES ============

// Health check
app.get('/api/health', (req, res) => {
  res.json({
    status: 'healthy',
    service: 'City Delivery API',
    version: '1.0.0',
    timestamp: new Date().toISOString(),
  });
});

// API Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
app.use('/api/auth', authRoutes);
app.use('/api/orders', orderRoutes);
app.use('/api/products', productRoutes);
app.use('/api/cart', cartRoutes);           // âœ… Phase 3: Smart Cart
app.use('/api/tracking', trackingRoutes);   // âœ… Phase 3: Real-time Tracking
app.use('/api/checkout', checkoutRoutes);   // âœ… Phase 4: Checkout Optimization
app.use('/api/payments', paymentRoutes);   // âœ… Payments: Ð®Kassa Integration
// TODO: Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
// app.use('/api/couriers', courierRoutes);
// app.use('/api/pickers', pickerRoutes);
// app.use('/api/admin', adminRoutes);

// Ð¡Ñ‚Ð°Ñ‚Ð¸ÐºÐ° Ð´Ð»Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
app.use('/uploads', express.static('uploads'));

// 404 Handler
app.use((req, res) => {
  res.status(404).json({
    error: 'ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½',
    path: req.path,
  });
});

// Error Handler
app.use((err, req, res, next) => {
  console.error('Error:', err);
  res.status(err.status || 500).json({
    error: err.message || 'Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack }),
  });
});

// ============ WEBSOCKET ============

setupWebSocket(io);

// ============ SERVER START ============

const PORT = process.env.PORT || 5000;

server.listen(PORT, async () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
  console.log(`ðŸ“¡ API Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://localhost:${PORT}/api`);
  console.log(`ðŸ“¡ WebSocket Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° ws://localhost:${PORT}`);
  console.log(`ðŸŒ ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ: ${process.env.NODE_ENV || 'development'}`);
  
  // ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÑŽÑ‰Ð¸Ñ…ÑÑ Ð·Ð°Ð´Ð°Ñ‡
  await queueService.setupRecurringJobs();
  console.log(`â° ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€ÑÑŽÑ‰Ð¸ÐµÑÑ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹`);
});

// Graceful shutdown
process.on('SIGTERM', async () => {
  console.log('SIGTERM signal received: closing HTTP server');
  
  // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸
  await queueService.close();
  
  server.close(() => {
    console.log('HTTP server closed');
    process.exit(0);
  });
});

process.on('SIGINT', async () => {
  console.log('SIGINT signal received: closing HTTP server');
  
  // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸
  await queueService.close();
  
  server.close(() => {
    console.log('HTTP server closed');
    process.exit(0);
  });
});

module.exports = { app, server, io };
